(()=>{"use strict";var t,e={};t=e,Object.defineProperty(t,"__esModule",{value:!0}),t.default=class{constructor(t,e,n){this.anno=t,this.storage=e,this.anno.disableEditor=!0,this.annotationContainer=n,document.addEventListener("annotations-loaded",this.handleAnnotationsLoaded.bind(this)),this.anno.on("createSelection",this.handleCreateSelection.bind(this)),this.anno.on("selectAnnotation",this.handleSelectAnnotation.bind(this))}handleAnnotationsLoaded(){this.annotationContainer.querySelectorAll(".annotation-display-container").forEach((t=>t.remove())),this.anno.getAnnotations().forEach((t=>{this.annotationContainer.append(this.createDisplayBlock(t))}))}async handleCreateSelection(t){const e=this.createEditorBlock(t);e&&this.annotationContainer.append(e)}handleSelectAnnotation(t){this.makeAllReadOnly();const e=document.querySelector('[data-annotation-id="'+t.id+'"]');e&&e instanceof HTMLElement&&this.makeEditable(e,t)}createDisplayBlock(t){const e=document.createElement("div");e.setAttribute("class","annotation-display-container");const n=document.createElement("div");return Array.isArray(t.body)&&t.body.length>0&&(n.innerHTML=t.body[0].value),e.append(n),void 0!==typeof t.id&&(e.dataset.annotationId=t.id,n.addEventListener("click",(()=>{this.anno.selectAnnotation(t.id),this.makeAllReadOnly(),this.makeEditable(e,t)}))),e}makeEditable(t,e){if("annotation-edit-container"==t.getAttribute("class"))return;t.setAttribute("class","annotation-edit-container");const n=t.querySelector("div");n&&(n.setAttribute("class","annotation-editor"),n.setAttribute("contenteditable","true"),n.focus());const a=document.createElement("button");a.setAttribute("class","save"),a.textContent="Save";const o=document.createElement("button");if(o.setAttribute("class","cancel"),o.textContent="Cancel",t.append(a),t.append(o),a.onclick=async()=>{e.motivation="supplementing",Array.isArray(e.body)&&0==e.body.length?e.body.push({type:"TextualBody",purpose:"transcribing",value:n?.textContent||"",format:"text/html"}):Array.isArray(e.body)&&(e.body[0].value=n?.textContent||""),await this.anno.updateSelected(e),this.anno.saveSelected(),this.makeReadOnly(t)},o.addEventListener("click",(()=>{this.anno.cancelSelected(),t.dataset.annotationId?this.makeReadOnly(t,e):t.remove()})),t.dataset.annotationId){const e=document.createElement("button");e.setAttribute("class","delete"),e.textContent="Delete",t.append(e),e.addEventListener("click",(()=>{this.anno.removeAnnotation(t.dataset.annotationId),t.remove(),this.storage.adapter.delete(t.dataset.annotationId)}))}return t}makeReadOnly(t,e){t.setAttribute("class","annotation-display-container");const n=t.querySelector("div");return n&&(n.setAttribute("class",""),n.setAttribute("contenteditable","false"),e&&void 0!==typeof e.body&&Array.isArray(e.body)&&(n.innerHTML=e.body[0].value,this.anno.addAnnotation(e))),t.querySelectorAll("button").forEach((t=>t.remove())),t}makeAllReadOnly(){document.querySelectorAll(".annotation-edit-container").forEach((t=>{t instanceof HTMLElement&&this.makeReadOnly(t)}))}createEditorBlock(t){return this.makeEditable(this.createDisplayBlock(t),t)}},module.exports=e})();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,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S3NELGFBQWEzQixFQUFXVCxHQUc3QlMsRUFBVWYsWUFLZGUsRUFBVVcsUUFBUUMsYUFBYyxDQUNoQyxNQUFNaUIsRUFBZXRELFNBQVMwQixjQUFjLFVBQzVDNEIsRUFBYTNCLGFBQWEsUUFBUyxVQUNuQzJCLEVBQWFaLFlBQWMsU0FDM0JqQixFQUFVWixPQUFPeUMsR0FFakJBLEVBQWFyRCxpQkFBaUIsU0FBUyxLQUVuQ0gsS0FBS0gsS0FBSzRELGlCQUFpQjlCLEVBQVVXLFFBQVFDLGNBRTdDWixFQUFVZixTQUdWWixLQUFLRixRQUFRNEQsUUFBUUMsT0FBT2hDLEVBQVVXLFFBQVFDLGlCQUl0RCxPQUFPWixFQUdYMkIsYUFBYTNCLEVBQXdCYixHQUdqQ2EsRUFBVUUsYUFBYSxRQUFTLGdDQUNoQyxNQUFNQyxFQUFZSCxFQUFVSixjQUFjLE9BbUIxQyxPQWxCSU8sSUFDQUEsRUFBVUQsYUFBYSxRQUFTLElBQ2hDQyxFQUFVRCxhQUFhLGtCQUFtQixTQUd0Q2YsUUFDMkJ1QixXQUFwQnZCLEVBQVdtQixNQUNsQkYsTUFBTUMsUUFBUWxCLEVBQVdtQixRQUV6QkgsRUFBVUssVUFBWXJCLEVBQVdtQixLQUFLLEdBQUdHLE1BR3pDcEMsS0FBS0gsS0FBSytELGNBQWM5QyxLQUloQ2EsRUFBVWxCLGlCQUFpQixVQUFVQyxTQUFTQyxHQUFPQSxFQUFHQyxXQUVqRGUsRUFHWE4sa0JBRUluQixTQUNLTyxpQkFBaUIsOEJBQ2pCQyxTQUFTaUIsSUFDRkEsYUFBcUJGLGFBQ3JCekIsS0FBS3NELGFBQWEzQixNQU1sQ1Asa0JBQWtCRixHQUVkLE9BQU9sQixLQUFLMEIsYUFBYTFCLEtBQUtnQixtQkFBbUJFLEdBQVlBLEsiLCJzb3VyY2VzIjpbIndlYnBhY2s6Ly9hbm5vdG9yaW91cy10YWhxaXEvLi9zcmMvaW5kZXgudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gY3VzdG9tIGFubm90YXRpb24gZWRpdG9yIGZvciBnZW5pemEgcHJvamVjdFxuXG5pbXBvcnQgeyBBbm5vdGF0aW9uIH0gZnJvbSBcIi4vdHlwZXMvQW5ub3RhdGlvblwiO1xuXG5jbGFzcyBUcmFuc2NyaXB0aW9uRWRpdG9yIHtcbiAgICBhbm5vO1xuXG4gICAgYW5ub3RhdGlvbkNvbnRhaW5lcjogSFRNTEVsZW1lbnQ7XG5cbiAgICBzdG9yYWdlO1xuXG4gICAgLy8gVE9ETzogQWRkIHR5cGVkZWZzIGZvciB0aGUgQW5ub3RvcmlvdXMgY2xpZW50IChhbm5vKSBhbmQgc3RvcmFnZSBwbHVnaW5cbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLWV4cGxpY2l0LWFueVxuICAgIGNvbnN0cnVjdG9yKGFubm86IGFueSwgc3RvcmFnZTogYW55LCBhbm5vdGF0aW9uQ29udGFpbmVyOiBIVE1MRWxlbWVudCkge1xuICAgICAgICB0aGlzLmFubm8gPSBhbm5vO1xuICAgICAgICB0aGlzLnN0b3JhZ2UgPSBzdG9yYWdlO1xuICAgICAgICAvLyBkaXNhYmxlIHRoZSBkZWZhdWx0IGFubm90b3Jpb3VzIGVkaXRvciAoaGVhZGxlc3MgbW9kZSlcbiAgICAgICAgdGhpcy5hbm5vLmRpc2FibGVFZGl0b3IgPSB0cnVlO1xuICAgICAgICB0aGlzLmFubm90YXRpb25Db250YWluZXIgPSBhbm5vdGF0aW9uQ29udGFpbmVyO1xuXG4gICAgICAgIC8vIGF0dGFjaCBldmVudCBsaXN0ZW5lcnNcbiAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcihcbiAgICAgICAgICAgIFwiYW5ub3RhdGlvbnMtbG9hZGVkXCIsXG4gICAgICAgICAgICB0aGlzLmhhbmRsZUFubm90YXRpb25zTG9hZGVkLmJpbmQodGhpcyksXG4gICAgICAgICk7XG4gICAgICAgIHRoaXMuYW5uby5vbihcImNyZWF0ZVNlbGVjdGlvblwiLCB0aGlzLmhhbmRsZUNyZWF0ZVNlbGVjdGlvbi5iaW5kKHRoaXMpKTtcbiAgICAgICAgdGhpcy5hbm5vLm9uKFxuICAgICAgICAgICAgXCJzZWxlY3RBbm5vdGF0aW9uXCIsXG4gICAgICAgICAgICB0aGlzLmhhbmRsZVNlbGVjdEFubm90YXRpb24uYmluZCh0aGlzKSxcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICBoYW5kbGVBbm5vdGF0aW9uc0xvYWRlZCgpIHtcbiAgICAgICAgLy8gY3VzdG9tIGV2ZW50IHRyaWdnZXJlZCBieSBzdG9yYWdlIHBsdWdpblxuXG4gICAgICAgIC8vIHJlbW92ZSBhbnkgZXhpc3RpbmcgYW5ub3RhdGlvbiBkaXNwbGF5cywgaW4gY2FzZSBvZiB1cGRhdGVcbiAgICAgICAgdGhpcy5hbm5vdGF0aW9uQ29udGFpbmVyXG4gICAgICAgICAgICAucXVlcnlTZWxlY3RvckFsbChcIi5hbm5vdGF0aW9uLWRpc3BsYXktY29udGFpbmVyXCIpXG4gICAgICAgICAgICAuZm9yRWFjaCgoZWwpID0+IGVsLnJlbW92ZSgpKTtcbiAgICAgICAgLy8gZGlzcGxheSBhbGwgY3VycmVudCBhbm5vdGF0aW9uc1xuICAgICAgICB0aGlzLmFubm8uZ2V0QW5ub3RhdGlvbnMoKS5mb3JFYWNoKChhbm5vdGF0aW9uOiBBbm5vdGF0aW9uKSA9PiB7XG4gICAgICAgICAgICB0aGlzLmFubm90YXRpb25Db250YWluZXIuYXBwZW5kKFxuICAgICAgICAgICAgICAgIHRoaXMuY3JlYXRlRGlzcGxheUJsb2NrKGFubm90YXRpb24pLFxuICAgICAgICAgICAgKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgYXN5bmMgaGFuZGxlQ3JlYXRlU2VsZWN0aW9uKHNlbGVjdGlvbjogQW5ub3RhdGlvbikge1xuICAgICAgICAvLyB3aGVuIGEgbmV3IHNlbGVjdGlvbiBpcyBtYWRlLCBpbnN0YW50aWF0ZSBhbiBlZGl0b3JcbiAgICAgICAgY29uc3QgZWRpdG9yQmxvY2sgPSB0aGlzLmNyZWF0ZUVkaXRvckJsb2NrKHNlbGVjdGlvbik7XG4gICAgICAgIGlmIChlZGl0b3JCbG9jaykgdGhpcy5hbm5vdGF0aW9uQ29udGFpbmVyLmFwcGVuZChlZGl0b3JCbG9jayk7XG4gICAgfVxuXG4gICAgaGFuZGxlU2VsZWN0QW5ub3RhdGlvbihhbm5vdGF0aW9uOiBBbm5vdGF0aW9uKSB7XG4gICAgICAgIC8vIFRoZSB1c2VyIGhhcyBzZWxlY3RlZCBhbiBleGlzdGluZyBhbm5vdGF0aW9uXG4gICAgICAgIC8vIG1ha2Ugc3VyZSBubyBvdGhlciBlZGl0b3IgaXMgYWN0aXZlXG4gICAgICAgIHRoaXMubWFrZUFsbFJlYWRPbmx5KCk7XG4gICAgICAgIC8vIGZpbmQgdGhlIGRpc3BsYXkgZWxlbWVudCBieSBhbm5vdGF0aW9uIGlkIGFuZCBzd2l0aCB0byBlZGl0IG1vZGVcbiAgICAgICAgY29uc3QgZGlzcGxheUNvbnRhaW5lciA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoXG4gICAgICAgICAgICAnW2RhdGEtYW5ub3RhdGlvbi1pZD1cIicgKyBhbm5vdGF0aW9uLmlkICsgJ1wiXScsXG4gICAgICAgICk7XG4gICAgICAgIGlmIChkaXNwbGF5Q29udGFpbmVyICYmIGRpc3BsYXlDb250YWluZXIgaW5zdGFuY2VvZiBIVE1MRWxlbWVudCkge1xuICAgICAgICAgICAgdGhpcy5tYWtlRWRpdGFibGUoZGlzcGxheUNvbnRhaW5lciwgYW5ub3RhdGlvbik7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBjcmVhdGVEaXNwbGF5QmxvY2soYW5ub3RhdGlvbjogQW5ub3RhdGlvbik6IEhUTUxFbGVtZW50IHtcbiAgICAgICAgY29uc3QgY29udGFpbmVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImRpdlwiKTtcbiAgICAgICAgY29udGFpbmVyLnNldEF0dHJpYnV0ZShcImNsYXNzXCIsIFwiYW5ub3RhdGlvbi1kaXNwbGF5LWNvbnRhaW5lclwiKTtcbiAgICAgICAgY29uc3QgdGV4dElucHV0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImRpdlwiKTtcblxuICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShhbm5vdGF0aW9uLmJvZHkpICYmIGFubm90YXRpb24uYm9keS5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICB0ZXh0SW5wdXQuaW5uZXJIVE1MID0gYW5ub3RhdGlvbi5ib2R5WzBdLnZhbHVlO1xuICAgICAgICB9XG4gICAgICAgIGNvbnRhaW5lci5hcHBlbmQodGV4dElucHV0KTtcblxuICAgICAgICAvLyBleGlzdGluZyBhbm5vdGF0aW9uXG4gICAgICAgIGlmICh0eXBlb2YgYW5ub3RhdGlvbi5pZCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICBjb250YWluZXIuZGF0YXNldC5hbm5vdGF0aW9uSWQgPSBhbm5vdGF0aW9uLmlkO1xuXG4gICAgICAgICAgICAvLyB3aGVuIHRoaXMgZGlzcGxheSBpcyBjbGlja2VkLCBoaWdobGlnaHQgdGhlIHpvbmUgYW5kIG1ha2UgZWRpdGFibGVcbiAgICAgICAgICAgIHRleHRJbnB1dC5hZGRFdmVudExpc3RlbmVyKFwiY2xpY2tcIiwgKCkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuYW5uby5zZWxlY3RBbm5vdGF0aW9uKGFubm90YXRpb24uaWQpO1xuICAgICAgICAgICAgICAgIC8vIG1ha2Ugc3VyZSBubyBvdGhlciBlZGl0b3JzIGFyZSBhY3RpdmVcbiAgICAgICAgICAgICAgICB0aGlzLm1ha2VBbGxSZWFkT25seSgpO1xuICAgICAgICAgICAgICAgIC8vIHNlbGVjdGlvbiBldmVudCBub3QgZmlyZWQgaW4gdGhpcyBjYXNlLCBzbyBtYWtlIGVkaXRhYmxlXG4gICAgICAgICAgICAgICAgdGhpcy5tYWtlRWRpdGFibGUoY29udGFpbmVyLCBhbm5vdGF0aW9uKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBjb250YWluZXI7XG4gICAgfVxuXG4gICAgbWFrZUVkaXRhYmxlKGNvbnRhaW5lcjogSFRNTEVsZW1lbnQsIHNlbGVjdGlvbjogQW5ub3RhdGlvbikge1xuICAgICAgICAvLyBtYWtlIGFuIGV4aXN0aW5nIGRpc3BsYXkgY29udGFpbmVyIGVkaXRhYmxlXG5cbiAgICAgICAgLy8gaWYgaXQncyBhbHJlYWR5IGVkaXRhYmxlLCBkb24ndCBkbyBhbnl0aGluZ1xuICAgICAgICBpZiAoY29udGFpbmVyLmdldEF0dHJpYnV0ZShcImNsYXNzXCIpID09IFwiYW5ub3RhdGlvbi1lZGl0LWNvbnRhaW5lclwiKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBjb250YWluZXIuc2V0QXR0cmlidXRlKFwiY2xhc3NcIiwgXCJhbm5vdGF0aW9uLWVkaXQtY29udGFpbmVyXCIpO1xuICAgICAgICBjb25zdCB0ZXh0SW5wdXQgPSBjb250YWluZXIucXVlcnlTZWxlY3RvcihcImRpdlwiKTtcbiAgICAgICAgaWYgKHRleHRJbnB1dCkge1xuICAgICAgICAgICAgdGV4dElucHV0LnNldEF0dHJpYnV0ZShcImNsYXNzXCIsIFwiYW5ub3RhdGlvbi1lZGl0b3JcIik7XG4gICAgICAgICAgICB0ZXh0SW5wdXQuc2V0QXR0cmlidXRlKFwiY29udGVudGVkaXRhYmxlXCIsIFwidHJ1ZVwiKTtcbiAgICAgICAgICAgIHRleHRJbnB1dC5mb2N1cygpO1xuICAgICAgICB9XG4gICAgICAgIC8vIGFkZCBzYXZlIGFuZCBjYW5jZWwgYnV0dG9uc1xuICAgICAgICBjb25zdCBzYXZlQnV0dG9uID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImJ1dHRvblwiKTtcbiAgICAgICAgc2F2ZUJ1dHRvbi5zZXRBdHRyaWJ1dGUoXCJjbGFzc1wiLCBcInNhdmVcIik7XG4gICAgICAgIHNhdmVCdXR0b24udGV4dENvbnRlbnQgPSBcIlNhdmVcIjtcbiAgICAgICAgY29uc3QgY2FuY2VsQnV0dG9uID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImJ1dHRvblwiKTtcbiAgICAgICAgY2FuY2VsQnV0dG9uLnNldEF0dHJpYnV0ZShcImNsYXNzXCIsIFwiY2FuY2VsXCIpO1xuICAgICAgICBjYW5jZWxCdXR0b24udGV4dENvbnRlbnQgPSBcIkNhbmNlbFwiO1xuICAgICAgICBjb250YWluZXIuYXBwZW5kKHNhdmVCdXR0b24pO1xuICAgICAgICBjb250YWluZXIuYXBwZW5kKGNhbmNlbEJ1dHRvbik7XG5cbiAgICAgICAgc2F2ZUJ1dHRvbi5vbmNsaWNrID0gYXN5bmMgKCkgPT4ge1xuICAgICAgICAgICAgLy8gYWRkIHRoZSBjb250ZW50IHRvIHRoZSBhbm5vdGF0aW9uXG4gICAgICAgICAgICBzZWxlY3Rpb24ubW90aXZhdGlvbiA9IFwic3VwcGxlbWVudGluZ1wiO1xuICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoc2VsZWN0aW9uLmJvZHkpICYmIHNlbGVjdGlvbi5ib2R5Lmxlbmd0aCA9PSAwKSB7XG4gICAgICAgICAgICAgICAgc2VsZWN0aW9uLmJvZHkucHVzaCh7XG4gICAgICAgICAgICAgICAgICAgIHR5cGU6IFwiVGV4dHVhbEJvZHlcIixcbiAgICAgICAgICAgICAgICAgICAgcHVycG9zZTogXCJ0cmFuc2NyaWJpbmdcIixcbiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IHRleHRJbnB1dD8udGV4dENvbnRlbnQgfHwgXCJcIixcbiAgICAgICAgICAgICAgICAgICAgZm9ybWF0OiBcInRleHQvaHRtbFwiLFxuICAgICAgICAgICAgICAgICAgICAvLyBUT0RPOiB0cmFuc2NyaXB0aW9uIG1vdGl2YXRpb24sIGxhbmd1YWdlLCBldGMuXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKEFycmF5LmlzQXJyYXkoc2VsZWN0aW9uLmJvZHkpKSB7XG4gICAgICAgICAgICAgICAgLy8gYXNzdW1lIHRleHQgY29udGVudCBpcyBmaXJzdCBib2R5IGVsZW1lbnRcbiAgICAgICAgICAgICAgICBzZWxlY3Rpb24uYm9keVswXS52YWx1ZSA9IHRleHRJbnB1dD8udGV4dENvbnRlbnQgfHwgXCJcIjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIC8vIHVwZGF0ZSB3aXRoIGFubm90b3Jpb3VzLCB0aGVuIHNhdmUgdG8gc3RvcmFnZSBiYWNrZW5kXG4gICAgICAgICAgICBhd2FpdCB0aGlzLmFubm8udXBkYXRlU2VsZWN0ZWQoc2VsZWN0aW9uKTtcbiAgICAgICAgICAgIHRoaXMuYW5uby5zYXZlU2VsZWN0ZWQoKTtcbiAgICAgICAgICAgIC8vIG1ha2UgdGhlIGVkaXRvciBpbmFjdGl2ZVxuICAgICAgICAgICAgdGhpcy5tYWtlUmVhZE9ubHkoY29udGFpbmVyKTtcbiAgICAgICAgfTtcbiAgICAgICAgY2FuY2VsQnV0dG9uLmFkZEV2ZW50TGlzdGVuZXIoXCJjbGlja1wiLCAoKSA9PiB7XG4gICAgICAgICAgICAvLyBjYW5jZWwgdGhlIGVkaXRcblxuICAgICAgICAgICAgLy8gY2xlYXIgdGhlIHNlbGVjdGlvbiBmcm9tIHRoZSBpbWFnZVxuICAgICAgICAgICAgdGhpcy5hbm5vLmNhbmNlbFNlbGVjdGVkKCk7XG4gICAgICAgICAgICAvLyBpZiBhbm5vdGF0aW9uIGlzIHVuc2F2ZWQsIHJlc3RvcmUgYW5kIG1ha2UgcmVhZCBvbmx5XG4gICAgICAgICAgICBpZiAoY29udGFpbmVyLmRhdGFzZXQuYW5ub3RhdGlvbklkKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5tYWtlUmVhZE9ubHkoY29udGFpbmVyLCBzZWxlY3Rpb24pO1xuICAgICAgICAgICAgICAgIC8vIGlmIHRoaXMgd2FzIGEgbmV3IGFubm90YXRpb24sIHJlbW92ZSB0aGUgY29udGFpbmVyXG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGNvbnRhaW5lci5yZW1vdmUoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gaWYgdGhpcyBpcyBhIHNhdmVkIGFubm90YXRpb24sIGFkZCBkZWxldGUgYnV0dG9uXG4gICAgICAgIGlmIChjb250YWluZXIuZGF0YXNldC5hbm5vdGF0aW9uSWQpIHtcbiAgICAgICAgICAgIGNvbnN0IGRlbGV0ZUJ1dHRvbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJidXR0b25cIik7XG4gICAgICAgICAgICBkZWxldGVCdXR0b24uc2V0QXR0cmlidXRlKFwiY2xhc3NcIiwgXCJkZWxldGVcIik7XG4gICAgICAgICAgICBkZWxldGVCdXR0b24udGV4dENvbnRlbnQgPSBcIkRlbGV0ZVwiO1xuICAgICAgICAgICAgY29udGFpbmVyLmFwcGVuZChkZWxldGVCdXR0b24pO1xuXG4gICAgICAgICAgICBkZWxldGVCdXR0b24uYWRkRXZlbnRMaXN0ZW5lcihcImNsaWNrXCIsICgpID0+IHtcbiAgICAgICAgICAgICAgICAvLyByZW1vdmUgdGhlIGhpZ2hsaWdodCB6b25lIGZyb20gdGhlIGltYWdlXG4gICAgICAgICAgICAgICAgdGhpcy5hbm5vLnJlbW92ZUFubm90YXRpb24oY29udGFpbmVyLmRhdGFzZXQuYW5ub3RhdGlvbklkKTtcbiAgICAgICAgICAgICAgICAvLyByZW1vdmUgdGhlIGVkaXQvZGlzcGxheSBjb250YWluZXJcbiAgICAgICAgICAgICAgICBjb250YWluZXIucmVtb3ZlKCk7XG4gICAgICAgICAgICAgICAgLy8gY2FsbGluZyByZW1vdmVBbm5vdGF0aW9uIGRvZXNuJ3QgZmlyZSB0aGUgZGVsZXRlQW5ub3RhdGlvbixcbiAgICAgICAgICAgICAgICAvLyBzbyB3ZSBoYXZlIHRvIHRyaWdnZXIgdGhlIGRlbGV0aW9uIGV4cGxpY2l0bHlcbiAgICAgICAgICAgICAgICB0aGlzLnN0b3JhZ2UuYWRhcHRlci5kZWxldGUoY29udGFpbmVyLmRhdGFzZXQuYW5ub3RhdGlvbklkKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGNvbnRhaW5lcjtcbiAgICB9XG5cbiAgICBtYWtlUmVhZE9ubHkoY29udGFpbmVyOiBIVE1MRWxlbWVudCwgYW5ub3RhdGlvbj86IEFubm90YXRpb24pIHtcbiAgICAgICAgLy8gY29udmVydCBhIGNvbnRhaW5lciB0aGF0IGhhcyBiZWVuIG1hZGUgZWRpdGFibGUgYmFjayB0byBkaXNwbGF5IGZvcm1hdFxuICAgICAgICAvLyBhbm5vdGF0aW9uIGlzIG9wdGlvbmFsOyB1c2VkIHRvIHJlc2V0IGNvbnRlbnQgaWYgbmVjZXNzYXJ5XG4gICAgICAgIGNvbnRhaW5lci5zZXRBdHRyaWJ1dGUoXCJjbGFzc1wiLCBcImFubm90YXRpb24tZGlzcGxheS1jb250YWluZXJcIik7XG4gICAgICAgIGNvbnN0IHRleHRJbnB1dCA9IGNvbnRhaW5lci5xdWVyeVNlbGVjdG9yKFwiZGl2XCIpO1xuICAgICAgICBpZiAodGV4dElucHV0KSB7XG4gICAgICAgICAgICB0ZXh0SW5wdXQuc2V0QXR0cmlidXRlKFwiY2xhc3NcIiwgXCJcIik7XG4gICAgICAgICAgICB0ZXh0SW5wdXQuc2V0QXR0cmlidXRlKFwiY29udGVudGVkaXRhYmxlXCIsIFwiZmFsc2VcIik7XG4gICAgICAgICAgICAvLyByZXN0b3JlIHRoZSBvcmlnaW5hbCBjb250ZW50XG4gICAgICAgICAgICBpZiAoXG4gICAgICAgICAgICAgICAgYW5ub3RhdGlvbiAmJlxuICAgICAgICAgICAgICAgIHR5cGVvZiBhbm5vdGF0aW9uLmJvZHkgIT09IHVuZGVmaW5lZCAmJlxuICAgICAgICAgICAgICAgIEFycmF5LmlzQXJyYXkoYW5ub3RhdGlvbi5ib2R5KVxuICAgICAgICAgICAgKSB7XG4gICAgICAgICAgICAgICAgdGV4dElucHV0LmlubmVySFRNTCA9IGFubm90YXRpb24uYm9keVswXS52YWx1ZTtcbiAgICAgICAgICAgICAgICAvLyBhZGQgdGhlIGFubm90YXRpb24gYWdhaW4gdG8gdXBkYXRlIHRoZSBpbWFnZSBzZWxlY3Rpb24gcmVnaW9uLFxuICAgICAgICAgICAgICAgIC8vIGluIGNhc2UgdGhlIHVzZXIgaGFzIG1vZGlmaWVkIGl0IGFuZCB3YW50cyB0byBjYW5jZWxcbiAgICAgICAgICAgICAgICB0aGlzLmFubm8uYWRkQW5ub3RhdGlvbihhbm5vdGF0aW9uKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICAvLyByZW1vdmUgYnV0dG9ucyAob3Igc2hvdWxkIHdlIGp1c3QgaGlkZSB0aGVtPylcbiAgICAgICAgY29udGFpbmVyLnF1ZXJ5U2VsZWN0b3JBbGwoXCJidXR0b25cIikuZm9yRWFjaCgoZWwpID0+IGVsLnJlbW92ZSgpKTtcblxuICAgICAgICByZXR1cm4gY29udGFpbmVyO1xuICAgIH1cblxuICAgIG1ha2VBbGxSZWFkT25seSgpIHtcbiAgICAgICAgLy8gbWFrZSBzdXJlIG5vIGVkaXRvciBpcyBhY3RpdmVcbiAgICAgICAgZG9jdW1lbnRcbiAgICAgICAgICAgIC5xdWVyeVNlbGVjdG9yQWxsKFwiLmFubm90YXRpb24tZWRpdC1jb250YWluZXJcIilcbiAgICAgICAgICAgIC5mb3JFYWNoKChjb250YWluZXIpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoY29udGFpbmVyIGluc3RhbmNlb2YgSFRNTEVsZW1lbnQpXG4gICAgICAgICAgICAgICAgICAgIHRoaXMubWFrZVJlYWRPbmx5KGNvbnRhaW5lcik7XG4gICAgICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvLyBtZXRob2QgdG8gY3JlYXRlIGFuIGVkaXRvciBibG9ja1xuICAgIC8vIGNvbnRhaW5lciwgZWRpdGFibGUgZGl2LCBidXR0b25zIHRvIHNhdmUvY2FuY2VsL2RlbGV0ZVxuICAgIGNyZWF0ZUVkaXRvckJsb2NrKHNlbGVjdGlvbjogQW5ub3RhdGlvbikge1xuICAgICAgICAvLyBjcmVhdGUgYSBuZXcgYW5ub3RhdGlvbiBlZGl0b3IgYmxvY2sgYW5kIHJldHVyblxuICAgICAgICByZXR1cm4gdGhpcy5tYWtlRWRpdGFibGUodGhpcy5jcmVhdGVEaXNwbGF5QmxvY2soc2VsZWN0aW9uKSwgc2VsZWN0aW9uKTtcbiAgICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IFRyYW5zY3JpcHRpb25FZGl0b3I7XG4iXSwibmFtZXMiOlsiY29uc3RydWN0b3IiLCJhbm5vIiwic3RvcmFnZSIsImFubm90YXRpb25Db250YWluZXIiLCJ0aGlzIiwiZGlzYWJsZUVkaXRvciIsImRvY3VtZW50IiwiYWRkRXZlbnRMaXN0ZW5lciIsImhhbmRsZUFubm90YXRpb25zTG9hZGVkIiwiYmluZCIsIm9uIiwiaGFuZGxlQ3JlYXRlU2VsZWN0aW9uIiwiaGFuZGxlU2VsZWN0QW5ub3RhdGlvbiIsInF1ZXJ5U2VsZWN0b3JBbGwiLCJmb3JFYWNoIiwiZWwiLCJyZW1vdmUiLCJnZXRBbm5vdGF0aW9ucyIsImFubm90YXRpb24iLCJhcHBlbmQiLCJjcmVhdGVEaXNwbGF5QmxvY2siLCJhc3luYyIsInNlbGVjdGlvbiIsImVkaXRvckJsb2NrIiwiY3JlYXRlRWRpdG9yQmxvY2siLCJtYWtlQWxsUmVhZE9ubHkiLCJkaXNwbGF5Q29udGFpbmVyIiwicXVlcnlTZWxlY3RvciIsImlkIiwiSFRNTEVsZW1lbnQiLCJtYWtlRWRpdGFibGUiLCJjb250YWluZXIiLCJjcmVhdGVFbGVtZW50Iiwic2V0QXR0cmlidXRlIiwidGV4dElucHV0IiwiQXJyYXkiLCJpc0FycmF5IiwiYm9keSIsImxlbmd0aCIsImlubmVySFRNTCIsInZhbHVlIiwidW5kZWZpbmVkIiwiZGF0YXNldCIsImFubm90YXRpb25JZCIsInNlbGVjdEFubm90YXRpb24iLCJnZXRBdHRyaWJ1dGUiLCJmb2N1cyIsInNhdmVCdXR0b24iLCJ0ZXh0Q29udGVudCIsImNhbmNlbEJ1dHRvbiIsIm9uY2xpY2siLCJtb3RpdmF0aW9uIiwicHVzaCIsInR5cGUiLCJwdXJwb3NlIiwiZm9ybWF0IiwidXBkYXRlU2VsZWN0ZWQiLCJzYXZlU2VsZWN0ZWQiLCJtYWtlUmVhZE9ubHkiLCJjYW5jZWxTZWxlY3RlZCIsImRlbGV0ZUJ1dHRvbiIsInJlbW92ZUFubm90YXRpb24iLCJhZGFwdGVyIiwiZGVsZXRlIiwiYWRkQW5ub3RhdGlvbiJdLCJzb3VyY2VSb290IjoiIn0=