(()=>{"use strict";var t,e={};t=e,Object.defineProperty(t,"__esModule",{value:!0}),t.default=class{constructor(t,e,n){this.anno=t,this.storage=e,this.anno.disableEditor=!0,this.injectIntoElement(n)}injectIntoElement(t){document.addEventListener("annotations-loaded",(()=>{t.querySelectorAll(".annotation-display-container").forEach((t=>t.remove())),this.anno.getAnnotations().forEach((e=>{t.append(this.createDisplayBlock(e))}))})),this.anno.on("createSelection",(async e=>{const n=this.createEditorBlock(e);n&&t.append(n)})),this.anno.on("selectAnnotation",(t=>{this.makeAllReadOnly();const e=document.querySelector('[data-annotation-id="'+t.id+'"]');e&&e instanceof HTMLElement&&this.makeEditable(e,t)}))}createDisplayBlock(t){const e=document.createElement("div");e.setAttribute("class","annotation-display-container");const n=document.createElement("div");return Array.isArray(t.body)&&t.body.length>0&&(n.innerHTML=t.body[0].value),e.append(n),void 0!==typeof t.id&&(e.dataset.annotationId=t.id,n.addEventListener("click",(()=>{this.anno.selectAnnotation(t.id),this.makeAllReadOnly(),this.makeEditable(e,t)}))),e}makeEditable(t,e){if("annotation-edit-container"==t.getAttribute("class"))return;t.setAttribute("class","annotation-edit-container");const n=t.querySelector("div");n&&(n.setAttribute("class","annotation-editor"),n.setAttribute("contenteditable","true"),n.focus());const a=document.createElement("button");a.setAttribute("class","save"),a.textContent="Save";const o=document.createElement("button");if(o.setAttribute("class","cancel"),o.textContent="Cancel",t.append(a),t.append(o),a.onclick=async()=>{e.motivation="supplementing",Array.isArray(e.body)&&0==e.body.length?e.body.push({type:"TextualBody",purpose:"transcribing",value:n?.textContent||"",format:"text/html"}):Array.isArray(e.body)&&(e.body[0].value=n?.textContent||""),await this.anno.updateSelected(e),this.anno.saveSelected(),this.makeReadOnly(t)},o.addEventListener("click",(()=>{this.anno.cancelSelected(),t.dataset.annotationId?this.makeReadOnly(t,e):t.remove()})),t.dataset.annotationId){const e=document.createElement("button");e.setAttribute("class","delete"),e.textContent="Delete",t.append(e),e.addEventListener("click",(()=>{this.anno.removeAnnotation(t.dataset.annotationId),t.remove(),this.storage.adapter.delete(t.dataset.annotationId)}))}return t}makeReadOnly(t,e){t.setAttribute("class","annotation-display-container");const n=t.querySelector("div");return n&&(n.setAttribute("class",""),n.setAttribute("contenteditable","false"),e&&void 0!==typeof e.body&&Array.isArray(e.body)&&(n.innerHTML=e.body[0].value,this.anno.addAnnotation(e))),t.querySelectorAll("button").forEach((t=>t.remove())),t}makeAllReadOnly(){document.querySelectorAll(".annotation-edit-container").forEach((t=>{t instanceof HTMLElement&&this.makeReadOnly(t)}))}createEditorBlock(t){return this.makeEditable(this.createDisplayBlock(t),t)}},module.exports=e})();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,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YTNCLGFBQWEsUUFBUyxVQUNuQzJCLEVBQWFaLFlBQWMsU0FDM0JqQixFQUFVYixPQUFPMEMsR0FFakJBLEVBQWFqRCxpQkFBaUIsU0FBUyxLQUVuQ0osS0FBS0gsS0FBS3lELGlCQUFpQjlCLEVBQVVXLFFBQVFDLGNBRTdDWixFQUFVaEIsU0FHVlIsS0FBS0YsUUFBUXlELFFBQVFDLE9BQU9oQyxFQUFVVyxRQUFRQyxpQkFJdEQsT0FBT1osRUFHWDJCLGFBQWEzQixFQUF3QmQsR0FHakNjLEVBQVVFLGFBQWEsUUFBUyxnQ0FDaEMsTUFBTUMsRUFBWUgsRUFBVUosY0FBYyxPQW1CMUMsT0FsQklPLElBQ0FBLEVBQVVELGFBQWEsUUFBUyxJQUNoQ0MsRUFBVUQsYUFBYSxrQkFBbUIsU0FHdENoQixRQUMyQndCLFdBQXBCeEIsRUFBV29CLE1BQ2xCRixNQUFNQyxRQUFRbkIsRUFBV29CLFFBRXpCSCxFQUFVSyxVQUFZdEIsRUFBV29CLEtBQUssR0FBR0csTUFHekNqQyxLQUFLSCxLQUFLNEQsY0FBYy9DLEtBSWhDYyxFQUFVbkIsaUJBQWlCLFVBQVVDLFNBQVNDLEdBQU9BLEVBQUdDLFdBRWpEZ0IsRUFHWE4sa0JBRUlmLFNBQ0tFLGlCQUFpQiw4QkFDakJDLFNBQVNrQixJQUNGQSxhQUFxQkYsYUFDckJ0QixLQUFLbUQsYUFBYTNCLE1BTWxDUCxrQkFBa0JGLEdBRWQsT0FBT2YsS0FBS3VCLGFBQWF2QixLQUFLWSxtQkFBbUJHLEdBQVlBLEsiLCJzb3VyY2VzIjpbIndlYnBhY2s6Ly9hbm5vdG9yaW91cy10YWhxaXEvLi9zcmMvaW5kZXgudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gY3VzdG9tIGFubm90YXRpb24gZWRpdG9yIGZvciBnZW5pemEgcHJvamVjdFxuXG5pbXBvcnQgeyBBbm5vdGF0aW9uIH0gZnJvbSBcIi4vdHlwZXMvQW5ub3RhdGlvblwiO1xuXG5jbGFzcyBUcmFuc2NyaXB0aW9uRWRpdG9yIHtcbiAgICBhbm5vO1xuXG4gICAgc3RvcmFnZTtcblxuICAgIC8vIFRPRE86IEFkZCB0eXBlZGVmcyBmb3IgdGhlIEFubm90b3Jpb3VzIGNsaWVudCAoYW5ubykgYW5kIHN0b3JhZ2UgcGx1Z2luXG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1leHBsaWNpdC1hbnlcbiAgICBjb25zdHJ1Y3Rvcihhbm5vOiBhbnksIHN0b3JhZ2U6IGFueSwgYW5ub3RhdGlvbkNvbnRhaW5lcjogSFRNTEVsZW1lbnQpIHtcbiAgICAgICAgdGhpcy5hbm5vID0gYW5ubztcbiAgICAgICAgdGhpcy5zdG9yYWdlID0gc3RvcmFnZTtcbiAgICAgICAgLy8gZGlzYWJsZSB0aGUgZGVmYXVsdCBhbm5vdG9yaW91cyBlZGl0b3IgKGhlYWRsZXNzIG1vZGUpXG4gICAgICAgIHRoaXMuYW5uby5kaXNhYmxlRWRpdG9yID0gdHJ1ZTtcbiAgICAgICAgdGhpcy5pbmplY3RJbnRvRWxlbWVudChhbm5vdGF0aW9uQ29udGFpbmVyKTtcbiAgICB9XG5cbiAgICBpbmplY3RJbnRvRWxlbWVudChhbm5vdGF0aW9uQ29udGFpbmVyOiBIVE1MRWxlbWVudCkge1xuICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKFwiYW5ub3RhdGlvbnMtbG9hZGVkXCIsICgpID0+IHtcbiAgICAgICAgICAgIC8vIGN1c3RvbSBldmVudCB0cmlnZ2VyZWQgYnkgc3RvcmFnZSBwbHVnaW5cblxuICAgICAgICAgICAgLy8gcmVtb3ZlIGFueSBleGlzdGluZyBhbm5vdGF0aW9uIGRpc3BsYXlzLCBpbiBjYXNlIG9mIHVwZGF0ZVxuICAgICAgICAgICAgYW5ub3RhdGlvbkNvbnRhaW5lclxuICAgICAgICAgICAgICAgIC5xdWVyeVNlbGVjdG9yQWxsKFwiLmFubm90YXRpb24tZGlzcGxheS1jb250YWluZXJcIilcbiAgICAgICAgICAgICAgICAuZm9yRWFjaCgoZWwpID0+IGVsLnJlbW92ZSgpKTtcbiAgICAgICAgICAgIC8vIGRpc3BsYXkgYWxsIGN1cnJlbnQgYW5ub3RhdGlvbnNcbiAgICAgICAgICAgIHRoaXMuYW5uby5nZXRBbm5vdGF0aW9ucygpLmZvckVhY2goKGFubm90YXRpb246IEFubm90YXRpb24pID0+IHtcbiAgICAgICAgICAgICAgICBhbm5vdGF0aW9uQ29udGFpbmVyLmFwcGVuZCh0aGlzLmNyZWF0ZURpc3BsYXlCbG9jayhhbm5vdGF0aW9uKSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gd2hlbiBhIG5ldyBzZWxlY3Rpb24gaXMgbWFkZSwgaW5zdGFudGlhdGUgYW4gZWRpdG9yXG4gICAgICAgIHRoaXMuYW5uby5vbihcImNyZWF0ZVNlbGVjdGlvblwiLCBhc3luYyAoc2VsZWN0aW9uOiBBbm5vdGF0aW9uKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBlZGl0b3JCbG9jayA9IHRoaXMuY3JlYXRlRWRpdG9yQmxvY2soc2VsZWN0aW9uKTtcbiAgICAgICAgICAgIGlmIChlZGl0b3JCbG9jaykgYW5ub3RhdGlvbkNvbnRhaW5lci5hcHBlbmQoZWRpdG9yQmxvY2spO1xuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLmFubm8ub24oXCJzZWxlY3RBbm5vdGF0aW9uXCIsIChhbm5vdGF0aW9uOiBBbm5vdGF0aW9uKSA9PiB7XG4gICAgICAgICAgICAvLyBUaGUgdXNlcnMgaGFzIHNlbGVjdGVkIGFuIGV4aXN0aW5nIGFubm90YXRpb25cblxuICAgICAgICAgICAgLy8gbWFrZSBzdXJlIG5vIG90aGVyIGVkaXRvciBpcyBhY3RpdmVcbiAgICAgICAgICAgIHRoaXMubWFrZUFsbFJlYWRPbmx5KCk7XG4gICAgICAgICAgICAvLyBmaW5kIHRoZSBkaXNwbGF5IGVsZW1lbnQgYnkgYW5ub3RhdGlvbiBpZCBhbmQgc3dpdGggdG8gZWRpdCBtb2RlXG4gICAgICAgICAgICBjb25zdCBkaXNwbGF5Q29udGFpbmVyID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihcbiAgICAgICAgICAgICAgICAnW2RhdGEtYW5ub3RhdGlvbi1pZD1cIicgKyBhbm5vdGF0aW9uLmlkICsgJ1wiXScsXG4gICAgICAgICAgICApO1xuICAgICAgICAgICAgaWYgKGRpc3BsYXlDb250YWluZXIgJiYgZGlzcGxheUNvbnRhaW5lciBpbnN0YW5jZW9mIEhUTUxFbGVtZW50KSB7XG4gICAgICAgICAgICAgICAgdGhpcy5tYWtlRWRpdGFibGUoZGlzcGxheUNvbnRhaW5lciwgYW5ub3RhdGlvbik7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIGNyZWF0ZURpc3BsYXlCbG9jayhhbm5vdGF0aW9uOiBBbm5vdGF0aW9uKTogSFRNTEVsZW1lbnQge1xuICAgICAgICBjb25zdCBjb250YWluZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiZGl2XCIpO1xuICAgICAgICBjb250YWluZXIuc2V0QXR0cmlidXRlKFwiY2xhc3NcIiwgXCJhbm5vdGF0aW9uLWRpc3BsYXktY29udGFpbmVyXCIpO1xuICAgICAgICBjb25zdCB0ZXh0SW5wdXQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiZGl2XCIpO1xuXG4gICAgICAgIGlmIChBcnJheS5pc0FycmF5KGFubm90YXRpb24uYm9keSkgJiYgYW5ub3RhdGlvbi5ib2R5Lmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIHRleHRJbnB1dC5pbm5lckhUTUwgPSBhbm5vdGF0aW9uLmJvZHlbMF0udmFsdWU7XG4gICAgICAgIH1cbiAgICAgICAgY29udGFpbmVyLmFwcGVuZCh0ZXh0SW5wdXQpO1xuXG4gICAgICAgIC8vIGV4aXN0aW5nIGFubm90YXRpb25cbiAgICAgICAgaWYgKHR5cGVvZiBhbm5vdGF0aW9uLmlkICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIGNvbnRhaW5lci5kYXRhc2V0LmFubm90YXRpb25JZCA9IGFubm90YXRpb24uaWQ7XG5cbiAgICAgICAgICAgIC8vIHdoZW4gdGhpcyBkaXNwbGF5IGlzIGNsaWNrZWQsIGhpZ2hsaWdodCB0aGUgem9uZSBhbmQgbWFrZSBlZGl0YWJsZVxuICAgICAgICAgICAgdGV4dElucHV0LmFkZEV2ZW50TGlzdGVuZXIoXCJjbGlja1wiLCAoKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5hbm5vLnNlbGVjdEFubm90YXRpb24oYW5ub3RhdGlvbi5pZCk7XG4gICAgICAgICAgICAgICAgLy8gbWFrZSBzdXJlIG5vIG90aGVyIGVkaXRvcnMgYXJlIGFjdGl2ZVxuICAgICAgICAgICAgICAgIHRoaXMubWFrZUFsbFJlYWRPbmx5KCk7XG4gICAgICAgICAgICAgICAgLy8gc2VsZWN0aW9uIGV2ZW50IG5vdCBmaXJlZCBpbiB0aGlzIGNhc2UsIHNvIG1ha2UgZWRpdGFibGVcbiAgICAgICAgICAgICAgICB0aGlzLm1ha2VFZGl0YWJsZShjb250YWluZXIsIGFubm90YXRpb24pO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGNvbnRhaW5lcjtcbiAgICB9XG5cbiAgICBtYWtlRWRpdGFibGUoY29udGFpbmVyOiBIVE1MRWxlbWVudCwgc2VsZWN0aW9uOiBBbm5vdGF0aW9uKSB7XG4gICAgICAgIC8vIG1ha2UgYW4gZXhpc3RpbmcgZGlzcGxheSBjb250YWluZXIgZWRpdGFibGVcblxuICAgICAgICAvLyBpZiBpdCdzIGFscmVhZHkgZWRpdGFibGUsIGRvbid0IGRvIGFueXRoaW5nXG4gICAgICAgIGlmIChjb250YWluZXIuZ2V0QXR0cmlidXRlKFwiY2xhc3NcIikgPT0gXCJhbm5vdGF0aW9uLWVkaXQtY29udGFpbmVyXCIpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnRhaW5lci5zZXRBdHRyaWJ1dGUoXCJjbGFzc1wiLCBcImFubm90YXRpb24tZWRpdC1jb250YWluZXJcIik7XG4gICAgICAgIGNvbnN0IHRleHRJbnB1dCA9IGNvbnRhaW5lci5xdWVyeVNlbGVjdG9yKFwiZGl2XCIpO1xuICAgICAgICBpZiAodGV4dElucHV0KSB7XG4gICAgICAgICAgICB0ZXh0SW5wdXQuc2V0QXR0cmlidXRlKFwiY2xhc3NcIiwgXCJhbm5vdGF0aW9uLWVkaXRvclwiKTtcbiAgICAgICAgICAgIHRleHRJbnB1dC5zZXRBdHRyaWJ1dGUoXCJjb250ZW50ZWRpdGFibGVcIiwgXCJ0cnVlXCIpO1xuICAgICAgICAgICAgdGV4dElucHV0LmZvY3VzKCk7XG4gICAgICAgIH1cbiAgICAgICAgLy8gYWRkIHNhdmUgYW5kIGNhbmNlbCBidXR0b25zXG4gICAgICAgIGNvbnN0IHNhdmVCdXR0b24gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiYnV0dG9uXCIpO1xuICAgICAgICBzYXZlQnV0dG9uLnNldEF0dHJpYnV0ZShcImNsYXNzXCIsIFwic2F2ZVwiKTtcbiAgICAgICAgc2F2ZUJ1dHRvbi50ZXh0Q29udGVudCA9IFwiU2F2ZVwiO1xuICAgICAgICBjb25zdCBjYW5jZWxCdXR0b24gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiYnV0dG9uXCIpO1xuICAgICAgICBjYW5jZWxCdXR0b24uc2V0QXR0cmlidXRlKFwiY2xhc3NcIiwgXCJjYW5jZWxcIik7XG4gICAgICAgIGNhbmNlbEJ1dHRvbi50ZXh0Q29udGVudCA9IFwiQ2FuY2VsXCI7XG4gICAgICAgIGNvbnRhaW5lci5hcHBlbmQoc2F2ZUJ1dHRvbik7XG4gICAgICAgIGNvbnRhaW5lci5hcHBlbmQoY2FuY2VsQnV0dG9uKTtcblxuICAgICAgICBzYXZlQnV0dG9uLm9uY2xpY2sgPSBhc3luYyAoKSA9PiB7XG4gICAgICAgICAgICAvLyBhZGQgdGhlIGNvbnRlbnQgdG8gdGhlIGFubm90YXRpb25cbiAgICAgICAgICAgIHNlbGVjdGlvbi5tb3RpdmF0aW9uID0gXCJzdXBwbGVtZW50aW5nXCI7XG4gICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShzZWxlY3Rpb24uYm9keSkgJiYgc2VsZWN0aW9uLmJvZHkubGVuZ3RoID09IDApIHtcbiAgICAgICAgICAgICAgICBzZWxlY3Rpb24uYm9keS5wdXNoKHtcbiAgICAgICAgICAgICAgICAgICAgdHlwZTogXCJUZXh0dWFsQm9keVwiLFxuICAgICAgICAgICAgICAgICAgICBwdXJwb3NlOiBcInRyYW5zY3JpYmluZ1wiLFxuICAgICAgICAgICAgICAgICAgICB2YWx1ZTogdGV4dElucHV0Py50ZXh0Q29udGVudCB8fCBcIlwiLFxuICAgICAgICAgICAgICAgICAgICBmb3JtYXQ6IFwidGV4dC9odG1sXCIsXG4gICAgICAgICAgICAgICAgICAgIC8vIFRPRE86IHRyYW5zY3JpcHRpb24gbW90aXZhdGlvbiwgbGFuZ3VhZ2UsIGV0Yy5cbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoQXJyYXkuaXNBcnJheShzZWxlY3Rpb24uYm9keSkpIHtcbiAgICAgICAgICAgICAgICAvLyBhc3N1bWUgdGV4dCBjb250ZW50IGlzIGZpcnN0IGJvZHkgZWxlbWVudFxuICAgICAgICAgICAgICAgIHNlbGVjdGlvbi5ib2R5WzBdLnZhbHVlID0gdGV4dElucHV0Py50ZXh0Q29udGVudCB8fCBcIlwiO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLy8gdXBkYXRlIHdpdGggYW5ub3RvcmlvdXMsIHRoZW4gc2F2ZSB0byBzdG9yYWdlIGJhY2tlbmRcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuYW5uby51cGRhdGVTZWxlY3RlZChzZWxlY3Rpb24pO1xuICAgICAgICAgICAgdGhpcy5hbm5vLnNhdmVTZWxlY3RlZCgpO1xuICAgICAgICAgICAgLy8gbWFrZSB0aGUgZWRpdG9yIGluYWN0aXZlXG4gICAgICAgICAgICB0aGlzLm1ha2VSZWFkT25seShjb250YWluZXIpO1xuICAgICAgICB9O1xuICAgICAgICBjYW5jZWxCdXR0b24uYWRkRXZlbnRMaXN0ZW5lcihcImNsaWNrXCIsICgpID0+IHtcbiAgICAgICAgICAgIC8vIGNhbmNlbCB0aGUgZWRpdFxuXG4gICAgICAgICAgICAvLyBjbGVhciB0aGUgc2VsZWN0aW9uIGZyb20gdGhlIGltYWdlXG4gICAgICAgICAgICB0aGlzLmFubm8uY2FuY2VsU2VsZWN0ZWQoKTtcbiAgICAgICAgICAgIC8vIGlmIGFubm90YXRpb24gaXMgdW5zYXZlZCwgcmVzdG9yZSBhbmQgbWFrZSByZWFkIG9ubHlcbiAgICAgICAgICAgIGlmIChjb250YWluZXIuZGF0YXNldC5hbm5vdGF0aW9uSWQpIHtcbiAgICAgICAgICAgICAgICB0aGlzLm1ha2VSZWFkT25seShjb250YWluZXIsIHNlbGVjdGlvbik7XG4gICAgICAgICAgICAgICAgLy8gaWYgdGhpcyB3YXMgYSBuZXcgYW5ub3RhdGlvbiwgcmVtb3ZlIHRoZSBjb250YWluZXJcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgY29udGFpbmVyLnJlbW92ZSgpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICAvLyBpZiB0aGlzIGlzIGEgc2F2ZWQgYW5ub3RhdGlvbiwgYWRkIGRlbGV0ZSBidXR0b25cbiAgICAgICAgaWYgKGNvbnRhaW5lci5kYXRhc2V0LmFubm90YXRpb25JZCkge1xuICAgICAgICAgICAgY29uc3QgZGVsZXRlQnV0dG9uID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImJ1dHRvblwiKTtcbiAgICAgICAgICAgIGRlbGV0ZUJ1dHRvbi5zZXRBdHRyaWJ1dGUoXCJjbGFzc1wiLCBcImRlbGV0ZVwiKTtcbiAgICAgICAgICAgIGRlbGV0ZUJ1dHRvbi50ZXh0Q29udGVudCA9IFwiRGVsZXRlXCI7XG4gICAgICAgICAgICBjb250YWluZXIuYXBwZW5kKGRlbGV0ZUJ1dHRvbik7XG5cbiAgICAgICAgICAgIGRlbGV0ZUJ1dHRvbi5hZGRFdmVudExpc3RlbmVyKFwiY2xpY2tcIiwgKCkgPT4ge1xuICAgICAgICAgICAgICAgIC8vIHJlbW92ZSB0aGUgaGlnaGxpZ2h0IHpvbmUgZnJvbSB0aGUgaW1hZ2VcbiAgICAgICAgICAgICAgICB0aGlzLmFubm8ucmVtb3ZlQW5ub3RhdGlvbihjb250YWluZXIuZGF0YXNldC5hbm5vdGF0aW9uSWQpO1xuICAgICAgICAgICAgICAgIC8vIHJlbW92ZSB0aGUgZWRpdC9kaXNwbGF5IGNvbnRhaW5lclxuICAgICAgICAgICAgICAgIGNvbnRhaW5lci5yZW1vdmUoKTtcbiAgICAgICAgICAgICAgICAvLyBjYWxsaW5nIHJlbW92ZUFubm90YXRpb24gZG9lc24ndCBmaXJlIHRoZSBkZWxldGVBbm5vdGF0aW9uLFxuICAgICAgICAgICAgICAgIC8vIHNvIHdlIGhhdmUgdG8gdHJpZ2dlciB0aGUgZGVsZXRpb24gZXhwbGljaXRseVxuICAgICAgICAgICAgICAgIHRoaXMuc3RvcmFnZS5hZGFwdGVyLmRlbGV0ZShjb250YWluZXIuZGF0YXNldC5hbm5vdGF0aW9uSWQpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gY29udGFpbmVyO1xuICAgIH1cblxuICAgIG1ha2VSZWFkT25seShjb250YWluZXI6IEhUTUxFbGVtZW50LCBhbm5vdGF0aW9uPzogQW5ub3RhdGlvbikge1xuICAgICAgICAvLyBjb252ZXJ0IGEgY29udGFpbmVyIHRoYXQgaGFzIGJlZW4gbWFkZSBlZGl0YWJsZSBiYWNrIHRvIGRpc3BsYXkgZm9ybWF0XG4gICAgICAgIC8vIGFubm90YXRpb24gaXMgb3B0aW9uYWw7IHVzZWQgdG8gcmVzZXQgY29udGVudCBpZiBuZWNlc3NhcnlcbiAgICAgICAgY29udGFpbmVyLnNldEF0dHJpYnV0ZShcImNsYXNzXCIsIFwiYW5ub3RhdGlvbi1kaXNwbGF5LWNvbnRhaW5lclwiKTtcbiAgICAgICAgY29uc3QgdGV4dElucHV0ID0gY29udGFpbmVyLnF1ZXJ5U2VsZWN0b3IoXCJkaXZcIik7XG4gICAgICAgIGlmICh0ZXh0SW5wdXQpIHtcbiAgICAgICAgICAgIHRleHRJbnB1dC5zZXRBdHRyaWJ1dGUoXCJjbGFzc1wiLCBcIlwiKTtcbiAgICAgICAgICAgIHRleHRJbnB1dC5zZXRBdHRyaWJ1dGUoXCJjb250ZW50ZWRpdGFibGVcIiwgXCJmYWxzZVwiKTtcbiAgICAgICAgICAgIC8vIHJlc3RvcmUgdGhlIG9yaWdpbmFsIGNvbnRlbnRcbiAgICAgICAgICAgIGlmIChcbiAgICAgICAgICAgICAgICBhbm5vdGF0aW9uICYmXG4gICAgICAgICAgICAgICAgdHlwZW9mIGFubm90YXRpb24uYm9keSAhPT0gdW5kZWZpbmVkICYmXG4gICAgICAgICAgICAgICAgQXJyYXkuaXNBcnJheShhbm5vdGF0aW9uLmJvZHkpXG4gICAgICAgICAgICApIHtcbiAgICAgICAgICAgICAgICB0ZXh0SW5wdXQuaW5uZXJIVE1MID0gYW5ub3RhdGlvbi5ib2R5WzBdLnZhbHVlO1xuICAgICAgICAgICAgICAgIC8vIGFkZCB0aGUgYW5ub3RhdGlvbiBhZ2FpbiB0byB1cGRhdGUgdGhlIGltYWdlIHNlbGVjdGlvbiByZWdpb24sXG4gICAgICAgICAgICAgICAgLy8gaW4gY2FzZSB0aGUgdXNlciBoYXMgbW9kaWZpZWQgaXQgYW5kIHdhbnRzIHRvIGNhbmNlbFxuICAgICAgICAgICAgICAgIHRoaXMuYW5uby5hZGRBbm5vdGF0aW9uKGFubm90YXRpb24pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIC8vIHJlbW92ZSBidXR0b25zIChvciBzaG91bGQgd2UganVzdCBoaWRlIHRoZW0/KVxuICAgICAgICBjb250YWluZXIucXVlcnlTZWxlY3RvckFsbChcImJ1dHRvblwiKS5mb3JFYWNoKChlbCkgPT4gZWwucmVtb3ZlKCkpO1xuXG4gICAgICAgIHJldHVybiBjb250YWluZXI7XG4gICAgfVxuXG4gICAgbWFrZUFsbFJlYWRPbmx5KCkge1xuICAgICAgICAvLyBtYWtlIHN1cmUgbm8gZWRpdG9yIGlzIGFjdGl2ZVxuICAgICAgICBkb2N1bWVudFxuICAgICAgICAgICAgLnF1ZXJ5U2VsZWN0b3JBbGwoXCIuYW5ub3RhdGlvbi1lZGl0LWNvbnRhaW5lclwiKVxuICAgICAgICAgICAgLmZvckVhY2goKGNvbnRhaW5lcikgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChjb250YWluZXIgaW5zdGFuY2VvZiBIVE1MRWxlbWVudClcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5tYWtlUmVhZE9ubHkoY29udGFpbmVyKTtcbiAgICAgICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8vIG1ldGhvZCB0byBjcmVhdGUgYW4gZWRpdG9yIGJsb2NrXG4gICAgLy8gY29udGFpbmVyLCBlZGl0YWJsZSBkaXYsIGJ1dHRvbnMgdG8gc2F2ZS9jYW5jZWwvZGVsZXRlXG4gICAgY3JlYXRlRWRpdG9yQmxvY2soc2VsZWN0aW9uOiBBbm5vdGF0aW9uKSB7XG4gICAgICAgIC8vIGNyZWF0ZSBhIG5ldyBhbm5vdGF0aW9uIGVkaXRvciBibG9jayBhbmQgcmV0dXJuXG4gICAgICAgIHJldHVybiB0aGlzLm1ha2VFZGl0YWJsZSh0aGlzLmNyZWF0ZURpc3BsYXlCbG9jayhzZWxlY3Rpb24pLCBzZWxlY3Rpb24pO1xuICAgIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgVHJhbnNjcmlwdGlvbkVkaXRvcjtcbiJdLCJuYW1lcyI6WyJjb25zdHJ1Y3RvciIsImFubm8iLCJzdG9yYWdlIiwiYW5ub3RhdGlvbkNvbnRhaW5lciIsInRoaXMiLCJkaXNhYmxlRWRpdG9yIiwiaW5qZWN0SW50b0VsZW1lbnQiLCJkb2N1bWVudCIsImFkZEV2ZW50TGlzdGVuZXIiLCJxdWVyeVNlbGVjdG9yQWxsIiwiZm9yRWFjaCIsImVsIiwicmVtb3ZlIiwiZ2V0QW5ub3RhdGlvbnMiLCJhbm5vdGF0aW9uIiwiYXBwZW5kIiwiY3JlYXRlRGlzcGxheUJsb2NrIiwib24iLCJhc3luYyIsInNlbGVjdGlvbiIsImVkaXRvckJsb2NrIiwiY3JlYXRlRWRpdG9yQmxvY2siLCJtYWtlQWxsUmVhZE9ubHkiLCJkaXNwbGF5Q29udGFpbmVyIiwicXVlcnlTZWxlY3RvciIsImlkIiwiSFRNTEVsZW1lbnQiLCJtYWtlRWRpdGFibGUiLCJjb250YWluZXIiLCJjcmVhdGVFbGVtZW50Iiwic2V0QXR0cmlidXRlIiwidGV4dElucHV0IiwiQXJyYXkiLCJpc0FycmF5IiwiYm9keSIsImxlbmd0aCIsImlubmVySFRNTCIsInZhbHVlIiwidW5kZWZpbmVkIiwiZGF0YXNldCIsImFubm90YXRpb25JZCIsInNlbGVjdEFubm90YXRpb24iLCJnZXRBdHRyaWJ1dGUiLCJmb2N1cyIsInNhdmVCdXR0b24iLCJ0ZXh0Q29udGVudCIsImNhbmNlbEJ1dHRvbiIsIm9uY2xpY2siLCJtb3RpdmF0aW9uIiwicHVzaCIsInR5cGUiLCJwdXJwb3NlIiwiZm9ybWF0IiwidXBkYXRlU2VsZWN0ZWQiLCJzYXZlU2VsZWN0ZWQiLCJtYWtlUmVhZE9ubHkiLCJjYW5jZWxTZWxlY3RlZCIsImRlbGV0ZUJ1dHRvbiIsInJlbW92ZUFubm90YXRpb24iLCJhZGFwdGVyIiwiZGVsZXRlIiwiYWRkQW5ub3RhdGlvbiJdLCJzb3VyY2VSb290IjoiIn0=